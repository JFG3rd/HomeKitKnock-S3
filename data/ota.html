<!DOCTYPE html>
<html>
<head>
    <title>OTA Update</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="dark-mode-toggle">
        <label class="switch">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider"></span>
        </label>
        <span>Dark Mode</span>
    </div>
    <div class="version-info">
        <div>Version {{FW_VERSION}}</div>
        <div>Build {{FW_BUILD_TIME}}</div>
    </div>

    <div class="header-container">
        <h1 class="main-title">OTA Update</h1>
        <p>Enable OTA from the setup page before uploading new images.</p>
    </div>

    <div class="dashboard">
        <div class="container card setup-card">
            <h3 class="card-title">OTA Status</h3>
            <div class="flash-stats" id="otaStatus">
                <strong>Status:</strong> loading...
            </div>
            <div class="ota-banner" id="otaBanner" hidden>
                OTA is disabled. Enable it in Setup to upload firmware or filesystem images.
            </div>
            <div class="ota-note">
                Uploads are restricted to the local network and a time-limited OTA window.
            </div>
            <div class="button-row button-grid" style="margin-top: 12px;">
                <a class="button" href="/logs/camera" target="_blank" title="Open filtered camera/streaming logs.">üìπ Camera Logs</a>
                <a class="button" href="/logs/doorbell" target="_blank" title="Open filtered doorbell/SIP/TR-064 logs.">‚òéÔ∏è Doorbell Logs</a>
                <a class="button" href="/setup">Back to Setup</a>
            </div>
        </div>

        <div class="container card setup-card">
            <h3 class="card-title">Firmware Update</h3>
            <form id="fwForm" method="POST" action="/ota/update" enctype="multipart/form-data">
                <div class="file-picker">
                    <input type="file" id="fwFile" name="update" accept=".bin" required>
                    <div class="button file-button" aria-hidden="true">Choose Firmware File</div>
                    <div class="file-name" id="fwFileName">No file selected</div>
                </div>
                <button class="button" type="submit">Upload Firmware</button>
            </form>
        </div>

        <div class="container card setup-card">
            <h3 class="card-title">Filesystem Update (LittleFS)</h3>
            <form id="fsForm" method="POST" action="/ota/fs" enctype="multipart/form-data">
                <div class="file-picker">
                    <input type="file" id="fsFile" name="update" accept=".bin" required>
                    <div class="button file-button" aria-hidden="true">Choose Filesystem File</div>
                    <div class="file-name" id="fsFileName">No file selected</div>
                </div>
                <button class="button" type="submit">Upload Filesystem</button>
            </form>
            <div class="ota-note">
                Use the LittleFS image built by PlatformIO (Upload File System Image).
            </div>
        </div>
    </div>

    <script>
        const darkToggle = document.getElementById("darkModeToggle");
        const otaStatusEl = document.getElementById("otaStatus");
        const fwSubmit = document.querySelector("#fwForm button[type=\"submit\"]");
        const fsSubmit = document.querySelector("#fsForm button[type=\"submit\"]");
        const fwFile = document.getElementById("fwFile");
        const fsFile = document.getElementById("fsFile");
        const fwFileName = document.getElementById("fwFileName");
        const fsFileName = document.getElementById("fsFileName");
        const otaBanner = document.getElementById("otaBanner");

        function setDarkMode(enabled) {
            document.body.classList.toggle("dark-mode", enabled);
            localStorage.setItem("darkMode", enabled ? "enabled" : "disabled");
        }

        const savedDarkMode = localStorage.getItem("darkMode");
        const darkModeEnabled = savedDarkMode === null ? true : savedDarkMode === "enabled";
        darkToggle.checked = darkModeEnabled;
        setDarkMode(darkModeEnabled);
        darkToggle.addEventListener("change", () => {
            setDarkMode(darkToggle.checked);
        });

        function formatMs(ms) {
            if (!ms || ms <= 0) return "0s";
            const sec = Math.floor(ms / 1000);
            if (sec < 60) return `${sec}s`;
            const min = Math.floor(sec / 60);
            const rem = sec % 60;
            return `${min}m ${rem}s`;
        }

        function setFormsEnabled(enabled) {
            if (fwSubmit) fwSubmit.disabled = !enabled;
            if (fsSubmit) fsSubmit.disabled = !enabled;
            if (otaBanner) otaBanner.hidden = enabled;
        }

        function bindFilePicker(fileInput, label) {
            if (!fileInput || !label) return;
            fileInput.addEventListener("change", () => {
                if (fileInput.files && fileInput.files.length > 0) {
                    label.textContent = fileInput.files[0].name;
                } else {
                    label.textContent = "No file selected";
                }
            });
        }

        function fetchOtaStatus() {
            fetch("/ota/status", { credentials: "include" })
                .then(r => {
                    if (r.status === 401) {
                        otaStatusEl.innerHTML = "<strong>Status:</strong> authentication required";
                        setFormsEnabled(false);
                        return null;
                    }
                    if (!r.ok) {
                        otaStatusEl.innerHTML = "<strong>Status:</strong> unavailable";
                        setFormsEnabled(false);
                        return null;
                    }
                    return r.json();
                })
                .then(data => {
                    if (!data) return;
                    const configured = data.configured ? "configured" : "not configured";
                    const enabled = data.enabled
                        ? `enabled (${formatMs(data.remaining_ms)})`
                        : "disabled";
                    otaStatusEl.innerHTML = `<strong>Status:</strong> ${configured} | ${enabled}`;
                    setFormsEnabled(data.enabled);
                })
                .catch(err => {
                    console.error("OTA fetch error:", err);
                    otaStatusEl.innerHTML = "<strong>Status:</strong> unavailable";
                    setFormsEnabled(false);
                });
        }

        fetchOtaStatus();
        setInterval(fetchOtaStatus, 10000);
        bindFilePicker(fwFile, fwFileName);
        bindFilePicker(fsFile, fsFileName);
    </script>
</body>
</html>
