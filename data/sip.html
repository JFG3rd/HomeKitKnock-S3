<!DOCTYPE html>
<html>
<head>
    <title>SIP Setup</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="dark-mode-toggle">
        <label class="switch">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider"></span>
        </label>
        <span>Dark Mode</span>
    </div>

    <div class="container full-width">
        <h1>‚òéÔ∏è SIP Setup</h1>
        <p>Configure FRITZ!Box SIP credentials to ring internal phones.</p>
        <div class="flash-stats">
            <strong>FRITZ!Box SIP Setup Instructions</strong>
            <p><strong>1) Create an IP Phone in FRITZ!Box</strong></p>
            <ul>
                <li>FRITZ!Box UI ‚Üí Telefonie ‚Üí Telefonieger√§te</li>
                <li>Click "Neues Ger√§t einrichten"</li>
                <li>Select "Telefon (mit und ohne Anrufbeantworter)"</li>
                <li>Select "LAN/WLAN (IP-Telefon)"</li>
                <li>Enter username (e.g., 620) and password</li>
                <li>Give it a name like "ESP32-Doorbell"</li>
            </ul>
            <p><strong>2) Note the credentials</strong></p>
            <ul>
                <li>Username (Benutzername): This is your SIP username</li>
                <li>Password (Kennwort): This is your SIP password</li>
            </ul>
            <p><strong>3) Configure target number</strong></p>
            <ul>
                <li>Use **610 to ring all DECT phones</li>
                <li>Use **9 plus extension to ring a specific phone</li>
            </ul>
        <p><strong>FRITZ!Box address:</strong> <span id="gateway_ip">Loading...</span></p>
        </div>

        <h3 class="card-title">üì° SIP Credentials</h3>
        <label><strong>SIP Username:</strong></label>
        <input type="text" id="sip_user" placeholder="e.g., 620">

        <label><strong>SIP Password:</strong></label>
        <input type="password" id="sip_password" placeholder="IP phone password">

        <label><strong>Display Name:</strong></label>
        <input type="text" id="sip_displayname" placeholder="Doorbell">

        <h3 class="card-title">üìû Ring Configuration</h3>
        <label><strong>Target Number:</strong></label>
        <input type="text" id="sip_target" placeholder="e.g., **11">

        <h3 class="card-title">üêõ Debug Options</h3>
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <label class="switch">
                <input type="checkbox" id="verbose_logging" onchange="toggleVerboseLogging()">
                <span class="slider"></span>
            </label>
            <span><strong>Verbose Logging</strong> - Show full SIP packet content in serial logs</span>
        </div>

        <div>
            <button class="button btn-save" title="Save SIP credentials and ring target." onclick="saveSip()">üíæ Save</button>
            <button class="button btn-test" title="Trigger a SIP ring test." onclick="testRingSip()">üîî Test SIP Ring</button>
            <a class="button btn-nav" href="/" title="Return to the main dashboard.">Back</a>
        </div>
    </div>

    <script>
        // Dark mode handling
        const darkToggle = document.getElementById("darkModeToggle");
        function setDarkMode(enabled) {
            document.body.classList.toggle("dark-mode", enabled);
            localStorage.setItem("darkMode", enabled ? "enabled" : "disabled");
        }
        const savedDarkMode = localStorage.getItem("darkMode");
        const darkModeEnabled = savedDarkMode === null ? true : savedDarkMode === "enabled";
        darkToggle.checked = darkModeEnabled;
        setDarkMode(darkModeEnabled);
        darkToggle.addEventListener("change", () => {
            setDarkMode(darkToggle.checked);
        });

        function saveSip() {
            let sip_user = document.getElementById("sip_user").value;
            let sip_password = document.getElementById("sip_password").value;
            let sip_displayname = document.getElementById("sip_displayname").value;
            let sip_target = document.getElementById("sip_target").value;

            fetch("/saveSIP", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    "sip_user": sip_user, 
                    "sip_password": sip_password, 
                    "sip_displayname": sip_displayname, 
                    "sip_target": sip_target
                })
            }).then(r => r.text())
              .then(t => alert(t))
              .catch(e => alert("Save failed: " + e));
        }

        function testRingSip() {
            fetch("/ring/sip")
                .then(r => r.text())
                .then(t => alert(t))
                .catch(e => alert("SIP Ring failed: " + e));
        }

        // Load current SIP config on page load
        function loadSipConfig() {
            fetch("/api/sip")
                .then(r => r.json())
                .then(data => {
                    if (data.user) document.getElementById("sip_user").value = data.user;
                    if (data.displayname) document.getElementById("sip_displayname").value = data.displayname;
                    if (data.target) document.getElementById("sip_target").value = data.target;
                    // Don't populate password for security
                })
                .catch(e => console.log("Could not load SIP config:", e));

            // Get gateway IP from status endpoint
            fetch("/api/status")
                .then(r => r.json())
                .then(data => {
                    if (data.gateway) {
                        document.getElementById("gateway_ip").textContent = data.gateway;
                    } else {
                        document.getElementById("gateway_ip").textContent = "Unknown";
                    }
                })
                .catch(e => {
                    document.getElementById("gateway_ip").textContent = "Unknown";
                });

            // Load verbose logging state
            fetch("/api/sip/verbose")
                .then(r => r.json())
                .then(data => {
                    document.getElementById("verbose_logging").checked = data.verbose === true;
                })
                .catch(e => console.log("Could not load verbose state:", e));
        }

        function toggleVerboseLogging() {
            const enabled = document.getElementById("verbose_logging").checked;
            fetch("/api/sip/verbose", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ "verbose": enabled })
            })
            .then(r => r.json())
            .then(data => {
                console.log("Verbose logging:", data.verbose ? "enabled" : "disabled");
            })
            .catch(e => {
                console.error("Failed to set verbose logging:", e);
                // Revert checkbox on error
                document.getElementById("verbose_logging").checked = !enabled;
            });
        }

        // Load config when page loads
        loadSipConfig();
    </script>
</body>
</html>
