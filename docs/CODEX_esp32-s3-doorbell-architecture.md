<!--
 Project: HomeKitKnock-S3
 File: docs/esp32-s3-doorbell-architecture_CODEX.md
 Generated by: GitHub Copilot (GPT-5.3-Codex)
 Date: February 12, 2026
 -->

# ESP32-S3 Doorbell Architecture (CODEX)

## Purpose
This document summarizes the **current implemented architecture** (not planned-state architecture) for the ESP-IDF firmware.

---

## High-Level System
- **Device:** Seeed XIAO ESP32-S3 Sense
- **Firmware base:** ESP-IDF (PlatformIO environment `seeed_xiao_esp32s3_idf`)
- **Core roles:**
  - Doorbell trigger input (GPIO button)
  - SIP intercom client to FRITZ!Box
  - Camera streaming (MJPEG HTTP + RTSP)
  - Audio capture/output pipeline (AAC + G.711 paths)
  - Web provisioning/config/logging/OTA

---

## Runtime Architecture

### 1) Boot + Deferred Initialization Pattern
`app_main()` initializes critical services in safe order:
1. NVS manager
2. Log buffer
3. Status LED + button
4. Wi-Fi manager
5. Wi-Fi start (STA or AP)

Heavy services are deferred to main loop via event flags:
- web server start
- SIP init
- camera/media init
- SNTP init
- DNS captive start/stop

This avoids stack pressure in network event callback contexts.

### 2) Main Loop Responsibilities
Main loop handles:
- Deferred service startups
- SIP signaling/media processing
- Deferred SIP ring execution
- Button debounce polling and callbacks
- LED state synthesis
- Periodic status logs

---

## Service Components and Data Paths

### Wi-Fi + Captive Portal
- `wifi_manager` drives STA/AP/APSTA behavior and event callbacks.
- `dns_server` forces captive-portal style resolution in AP mode.
- `web_server` hosts UI assets and APIs.

### Configuration + Persistence
- NVS namespaces hold Wi-Fi, SIP, camera, and audio settings.
- Camera/audio feature flags are runtime-controlled via `/saveFeatures` and persisted.
- SIP feature and verbose logging are persisted in SIP namespace.

### Button/Event Path
1. GPIO4 button press callback fires.
2. LED ring animation starts.
3. Local gong playback requested (speaker path).
4. SIP ring is requested via deferred flag (`sip_request_ring`).
5. Main loop executes pending SIP ring safely.
6. Scrypted webhook trigger is currently a TODO placeholder.

### SIP Signaling Path
- UDP local bind: `5062`
- Target proxy/domain: `fritz.box:5060`
- Auth model: Digest (401/407 challenge parsing + MD5 response)
- Call model:
  - REGISTER (periodic)
  - INVITE (initial + auth retry)
  - Provisional/final response handling
  - CANCEL on timeout
  - ACK/BYE progression for answered calls

### SIP Media Path (RTP)
- RTP socket on UDP `40000`.
- Codec negotiation from SDP supports PCMU/PCMA + telephone-event.
- TX media: mic PCM -> downsample -> G.711 -> RTP.
- RX media: RTP G.711 -> PCM -> speaker write.
- DTMF RFC4733 events parsed and surfaced through callback API.

### Camera + Media Streaming Path
- `camera` component captures OV2640 JPEG frames.
- `mjpeg_server` streams multipart MJPEG on port `81`.
- `rtsp_server` handles RTSP 1.0 control on `8554`:
  - video track: RTP/JPEG (PT=26)
  - audio track: RTP/AAC-hbr (PT=96)
- RTSP session model supports TCP interleaved; UDP transport support exists but is not enabled by default in current top-level wiring.

### Audio Pipeline Path
- `audio_capture`: PDM or INMP441 source, sensitivity/mute controls.
- `aac_encoder_pipe`: ESP-ADF-based AAC encode path for RTSP audio.
- `audio_output`: MAX98357A output path for gong/test tone and SIP receive audio.
- INMP441 + MAX98357A share BCLK/WS wiring (GPIO7/8) with separate data lines (GPIO12 RX, GPIO9 TX).

---

## Control Plane (HTTP)
Primary groups of endpoints:
- Device/Wi-Fi: `/api/wifi`, `/api/status`, `/restart`
- Logs/OTA: `/api/logs`, `/api/ota`
- Features/settings: `/api/features`, `/saveFeatures`, `/control`
- SIP: `/api/sip`, `/api/sip/ring`, `/api/sip/verbose`, legacy `/ring/sip`
- Camera: `/capture`, `/cameraStreamInfo`, `/status`

Legacy compatibility endpoints remain to support existing frontend flows.

---

## Concurrency and Resource Notes
- Main loop-centered orchestration reduces event-task stack risks.
- Media servers and audio processing are task-based with explicit stack sizes.
- SIP uses static buffers in critical paths to reduce transient stack usage.
- RTSP and MJPEG session counts are intentionally limited for stability.

---

## Known Architectural Gaps
- Scrypted webhook trigger is not yet wired in button handler.
- Inbound SIP call long-duration teardown path has an explicit TODO.
- Some legacy web handlers are placeholders/stubs.
- Build currently emits recurring `-fno-rtti` warnings for C compilation units.

---

## Architecture Snapshot Verdict
Current firmware architecture is a cohesive, event-driven embedded system with integrated:
- networking + provisioning,
- SIP intercom signaling/media,
- dual streaming paths (HTTP MJPEG + RTSP A/V),
- persistent configuration and OTA/log tooling.

Near-term architecture work is primarily integration-hardening and cleanup rather than foundational subsystem creation.
