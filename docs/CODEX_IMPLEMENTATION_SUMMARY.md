<!--
 Project: HomeKitKnock-S3
 File: docs/IMPLEMENTATION_SUMMARY_CODEX.md
 Generated by: GitHub Copilot (GPT-5.3-Codex)
 Date: February 12, 2026
 -->

# ESP32-S3 Doorbell - Implementation Summary (CODEX)

## Scope
This document is a code-verified status snapshot of the ESP-IDF implementation in `src_idf` as of **2026-02-12**.

---

## Overall Status
- **Migration state:** ESP-IDF firmware is beyond basic Phase 4 assumptions in older docs.
- **Video path:** HTTP MJPEG + RTSP are implemented and wired.
- **Audio path:** Mic capture, AAC encode for RTSP, and SIP G.711 RTP media are implemented.
- **SIP path:** Registration, digest auth, INVITE flow, CANCEL/ACK/BYE, and RTP/DTMF handling are implemented.
- **Web stack:** Captive portal, setup APIs, SIP APIs, OTA endpoint, logs, and embedded UI assets are active.

---

## Verified Runtime Flow (from `main.c`)
- Boot initializes NVS, log buffer, status LED, button, and Wi-Fi manager.
- Network events set deferred flags to start web server, SIP client, camera, and SNTP in main loop context.
- If camera feature is enabled:
  - Camera initializes.
  - MJPEG server starts on port `81`.
  - RTSP server starts on port `8554` when `rtsp_enabled` is true.
  - Mic capture starts when enabled.
  - AAC pipeline initializes for RTSP audio.
  - Speaker output initializes when available.
- Main loop runs SIP processing, button polling, LED state logic, and periodic status logging.

---

## Component Status

### Camera + MJPEG
- Implemented in `camera` + `mjpeg_server` components.
- Snapshot endpoint `/capture` implemented.
- Camera controls (`framesize`, `quality`, `brightness`, `contrast`) apply at runtime and persist to NVS.
- HTTP camera feature is gated by NVS flag `http_cam_en`.

### RTSP (Video + Audio)
- `rtsp_server` is implemented and integrated.
- Video transport: MJPEG over RTP (PT=26, RFC 2435).
- Audio transport: AAC-LC over RTP (PT=96, RFC 3640) with SDP track2 when mic enabled.
- Supports TCP interleaved transport.
- UDP mode exists but defaults to disabled unless `rtsp_server_set_allow_udp(true)` is called (currently not wired in main flow).

### Audio Capture / Output / AAC
- `audio_capture` supports:
  - Onboard PDM mic (I2S0)
  - External INMP441 (I2S1)
- `aac_encoder_pipe` uses ESP-ADF pipeline (`raw_stream -> aac_encoder -> raw_stream`) and lazily starts on first frame request.
- `audio_output` supports MAX98357A speaker and gong playback (embedded PCM with synthesized fallback).

### SIP + RTP + DTMF
- SIP signaling on local UDP `5062`, proxy/domain `fritz.box`, RTP port `40000`.
- REGISTER flow with 401/407 digest auth retry is implemented.
- INVITE flow with auth retry is implemented.
- Ring timeout and CANCEL behavior implemented.
- ACK/BYE call progression implemented for outbound ring path.
- RTP media handling:
  - TX: mic -> downsample -> G.711 (PCMU/PCMA)
  - RX: G.711 decode -> speaker output
- RFC4733 DTMF events are parsed and exposed via callback API.

### Web Server / API
- Core APIs: Wi-Fi, status, logs, OTA, features, SIP config/ring/verbose.
- Legacy compatibility endpoints are still present (`/saveWiFi`, `/scanWifi`, `/ring/sip`, etc.).
- Captive portal handlers for iOS/Android/Windows are implemented.
- Two legacy debug endpoints are stub-style handlers:
  - `/deviceStatus`
  - `/sipDebug`

### NVS + Recovery
- NVS manager handles recovery cases:
  - `ESP_ERR_NVS_NO_FREE_PAGES`
  - `ESP_ERR_NVS_NEW_VERSION_FOUND`
  - `ESP_ERR_NVS_INVALID_STATE`
- Recovery path erases NVS and re-initializes.

---

## Notable Gaps / TODOs (Code-Observed)
- `main.c` contains TODO to trigger Scrypted webhook on button press.
- `sip_client.c` contains TODO in inbound-call timeout path (`send BYE and reset call`).
- DTMF callback mechanism exists in SIP component, but no application-level callback wiring is visible in `main.c`.

---

## Build Warnings Snapshot
From current filtered build output (`build_errors.txt`):
- Repeated warning:
  - `cc1: warning: command-line option '-fno-rtti' is valid for C++/D/ObjC++ but not for C`
- Build exits successfully (`exit code 0`) despite warnings.

---

## API Surface (Practical)
- Wi-Fi: `/api/wifi`, `/saveWiFi`, `/scanWifi`, `/wifiScanResults`
- Status/logs: `/api/status`, `/status`, `/api/logs`
- Features: `/api/features`, `/saveFeatures`
- SIP: `/api/sip`, `/api/sip/ring`, `/api/sip/verbose`, `/ring/sip`, `/saveSIP`
- Camera/stream: `/capture`, `/cameraStreamInfo`, `/control`
- OTA/restart: `/api/ota`, `/restart`

---

## Practical Conclusion
The ESP-IDF branch is no longer just "SIP + basic camera"; it is a functioning integrated stack with:
- Wi-Fi provisioning and management
- Camera + MJPEG + RTSP streaming
- Audio capture/output and AAC pipeline
- SIP intercom with digest auth and RTP media
- Web UI/API + OTA + logs

Remaining work appears focused on product hardening, Scrypted button webhook integration, selective cleanup of legacy stubs/endpoints, and documenting operational limits/testing matrix.
