<!--
 Project: HomeKitKnock-S3
 File: docs/CODEX_WIRING_DIAGRAM.md
 Generated by: GitHub Copilot (Codex)
 Date: 2026-02-13
 -->

# CODEX Wiring Diagram (Rev B)

This document provides a clean wiring reference for the ESP32-S3 doorbell build, including:
- current production wiring, and
- recommended rewiring for concurrent external mic + speaker operation.

---

## 1) Current Baseline Wiring (as-built)

### Core IO
- **GPIO4** -> Doorbell switch (to GND, active-low)
- **GPIO2** -> Status LED (through 330R to LED anode)
- **GPIO1** -> Relay IN (door opener)
- **GPIO3** -> Relay IN (original 8VAC gong)
- **GPIO5** -> I2C SDA (optional; add 4.7k pull-up to 3V3)
- **GPIO6** -> I2C SCL (optional; add 4.7k pull-up to 3V3)

### MAX98357A (speaker DAC)
- **BCLK** -> GPIO7
- **LRC/WS** -> GPIO8
- **DIN** -> GPIO9
- **Vin** -> 3V3
- **GND** -> GND
- **SD/SC** -> 3V3 (always on)

### Onboard PDM microphone (XIAO Sense)
- **DATA** -> GPIO41
- **CLK** -> GPIO42

### External INMP441 microphone (current baseline)
- **SCK/BCLK** -> GPIO43
- **WS/LRCLK** -> GPIO44
- **SD/DOUT** -> GPIO12
- **L/R** -> GND (mono left)
- **VDD** -> 3V3
- **GND** -> GND

### Speaker
- MAX98357A **L+** -> Speaker +
- MAX98357A **L-** -> Speaker -
- Do **not** connect speaker terminals to GND.

---

## 2) Recommended Rewiring for Concurrent INMP441 + MAX98357A

Goal: share one I2S clock domain so external mic capture and speaker output can run concurrently.

### Shared-clock topology
Use shared lines for both devices:
- **Shared BCLK**: GPIO7
- **Shared WS/LRCLK**: GPIO8

Use separate data lines:
- **ESP -> DAC DOUT**: GPIO9 -> MAX98357A DIN
- **Mic -> ESP DIN**: INMP441 SD -> GPIO12

### Exact changes
- Keep MAX98357A as-is:
  - BCLK GPIO7, WS GPIO8, DIN GPIO9
- Rewire INMP441 clock lines:
  - Move INMP441 **SCK** from GPIO43 -> **GPIO7**
  - Move INMP441 **WS** from GPIO44 -> **GPIO8**
  - Keep INMP441 **SD** on GPIO12
- Keep INMP441 power pins unchanged (3V3/GND)

### Disconnect old wires
- Remove INMP441 SCK from GPIO43
- Remove INMP441 WS from GPIO44

---

## 3) Power and Relay Wiring

### Rails
- **3V3 rail** -> ESP32-S3 peripherals (MAX98357A, relays logic side, optional I2C devices)
- **GND rail** -> common logic ground

### Door opener relay
- VCC -> 3V3 (or 5V module if logic-compatible)
- GND -> GND
- IN -> GPIO1
- COM/NO -> door strike circuit (use strike supply voltage)

### Original gong relay (8VAC)
- VCC -> 3V3 (or 5V module if logic-compatible)
- GND -> GND
- IN -> GPIO3
- COM/NO -> 8VAC gong circuit (isolated contact side)

---

## 4) Audio/Bus Notes

- GPIO7/8/9 are occupied by speaker I2S; avoid SPI usage on these pins.
- For concurrent external mic + speaker, INMP441 and MAX98357A must share BCLK/WS.
- Onboard PDM mic remains on GPIO41/42 and does not use the external INMP441 wiring.
- Keep shared I2S clock wires short and routed cleanly to reduce noise/jitter.

---

## 5) Quick Continuity Checklist

- GPIO7 has exactly: MAX98357A BCLK + INMP441 SCK
- GPIO8 has exactly: MAX98357A WS + INMP441 WS
- GPIO9 goes only to MAX98357A DIN
- GPIO12 comes only from INMP441 SD
- No speaker terminal tied to GND
- Relay contact side remains isolated from ESP logic side

---

## 6) Free/Changed Header Pins

- After rewiring, **GPIO43 and GPIO44 become free** (if no other feature uses them).
- GPIO13 remains free on back expansion header.

---

## 7) Related Docs

- Original reference: [WIRING_DIAGRAM.md](WIRING_DIAGRAM.md)
- Power architecture: [POWER_SUPPLY_DESIGNS.md](POWER_SUPPLY_DESIGNS.md)
- Firmware architecture: [esp32-s3-doorbell-architecture.md](esp32-s3-doorbell-architecture.md)
